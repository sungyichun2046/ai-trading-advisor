# DAG Dependencies Configuration
# Configuration-driven dependency management with conditional logic

# Global settings
global:
  cache_dependencies: true
  cache_ttl: 3600  # 1 hour
  enable_skip_conditions: true
  default_timeout: 300  # 5 minutes

# DAG dependency configurations
dags:
  data_collection:
    description: "Collect market data, fundamentals, and sentiment"
    dependencies: []  # No upstream dependencies
    downstream: ["analysis"]
    
    # Skip conditions - when to skip this DAG
    skip_conditions:
      market_closed:
        enabled: true
        condition: "not is_market_open()"
        description: "Skip data collection when market is closed"
        environments: ["prod", "staging"]  # Only apply in prod/staging
        
      weekend:
        enabled: true
        condition: "get_market_session() == 'weekend'"
        description: "Skip on weekends"
        environments: ["prod"]
        
      holiday:
        enabled: true
        condition: "get_market_session() == 'holiday'"
        description: "Skip on market holidays"
        environments: ["prod", "staging"]
    
    # Task dependencies within DAG
    task_dependencies:
      collect_fundamental_data:
        depends_on: ["simple_collect_market_data"]
        timeout: 300
        
      simple_collect_sentiment:
        depends_on: ["simple_collect_market_data", "collect_fundamental_data"]
        timeout: 180
        
      monitor_data_systems:
        depends_on: ["simple_collect_market_data", "collect_fundamental_data", "simple_collect_sentiment"]
        timeout: 60

  analysis:
    description: "Analyze market data using multiple strategies"
    dependencies: ["data_collection"]
    downstream: ["trading"]
    
    # Skip conditions
    skip_conditions:
      no_fresh_data:
        enabled: true
        condition: "check_data_freshness() < 0.8"
        description: "Skip if data collection failed or is stale"
        environments: ["prod", "staging", "dev"]
        
      insufficient_data:
        enabled: true
        condition: "get_market_data_count() < 100"
        description: "Skip if insufficient market data points"
        environments: ["prod", "staging"]
        
      low_volatility:
        enabled: false  # Disabled by default
        condition: "get_market_volatility() < 0.1"
        description: "Skip analysis during extremely low volatility"
        environments: ["prod"]
    
    # Task dependencies within DAG
    task_dependencies:
      simple_fundamental_analysis:
        depends_on: ["simple_technical_analysis"]
        timeout: 240
        
      simple_sentiment_analysis:
        depends_on: ["simple_technical_analysis"]
        timeout: 120
        
      calculate_consensus_signals:
        depends_on: ["simple_technical_analysis", "simple_fundamental_analysis", "simple_sentiment_analysis"]
        timeout: 180
        
      monitor_analysis_systems:
        depends_on: ["calculate_consensus_signals"]
        timeout: 60

  trading:
    description: "Execute trading decisions based on analysis"
    dependencies: ["analysis"]
    downstream: []
    
    # Skip conditions
    skip_conditions:
      market_closed:
        enabled: true
        condition: "not is_market_open()"
        description: "No trading when market is closed"
        environments: ["prod", "staging"]
        
      low_confidence:
        enabled: true
        condition: "get_consensus_confidence() < 0.6"
        description: "Skip trading with low confidence signals"
        environments: ["prod", "staging"]
        
      high_volatility:
        enabled: true
        condition: "get_market_volatility() > 0.5"
        description: "Avoid trading in extreme volatility"
        environments: ["prod"]
        
      paper_trading_only:
        enabled: true
        condition: "get_environment() == 'dev'"
        description: "Force paper trading in development"
        environments: ["dev"]
        
      risk_limits_exceeded:
        enabled: true
        condition: "check_risk_limits_exceeded()"
        description: "Stop trading if risk limits are breached"
        environments: ["prod", "staging", "dev"]
    
    # Task dependencies within DAG
    task_dependencies:
      simple_assess_risk:
        depends_on: ["simple_generate_signals"]
        timeout: 120
        
      simple_execute_trades:
        depends_on: ["simple_generate_signals", "simple_assess_risk"]
        timeout: 300
        
      monitor_trading_systems:
        depends_on: ["simple_execute_trades"]
        timeout: 60

# Cross-DAG dependency rules
cross_dag_dependencies:
  data_freshness:
    description: "Ensure data is fresh before analysis"
    source_dag: "data_collection"
    target_dag: "analysis"
    condition: "data_collection_success and data_age < 300"  # 5 minutes
    
  analysis_quality:
    description: "Ensure quality analysis before trading"
    source_dag: "analysis"
    target_dag: "trading"
    condition: "analysis_success and confidence > 0.5"
    
  market_session_alignment:
    description: "Align all DAGs with market sessions"
    applies_to: ["data_collection", "analysis", "trading"]
    condition: "get_market_session() in ['pre_market', 'open', 'after_hours']"

# Environment-specific overrides
environment_overrides:
  development:
    skip_conditions:
      # More lenient in dev
      market_closed:
        enabled: false
      weekend:
        enabled: false
      holiday:
        enabled: false
    task_timeouts:
      default: 60  # Shorter timeouts in dev
      
  staging:
    skip_conditions:
      # Similar to prod but allow some testing
      low_volatility:
        enabled: true
    task_timeouts:
      default: 180
      
  production:
    skip_conditions:
      # Strictest rules in production
      all_enabled: true
    task_timeouts:
      default: 300
    alerts:
      enabled: true
      channels: ["email", "slack", "webhook"]

# Monitoring and alerting
monitoring:
  dependency_failures:
    enabled: true
    alert_after: 3  # Alert after 3 consecutive failures
    channels: ["log", "email"]
    
  skip_rate_monitoring:
    enabled: true
    threshold: 0.5  # Alert if >50% of runs are skipped
    window: "24h"
    channels: ["log", "slack"]
    
  performance_monitoring:
    enabled: true
    slow_task_threshold: 600  # 10 minutes
    channels: ["log"]